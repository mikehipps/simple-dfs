<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV Match (Round 4)</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
</head>
<body class="theme-dark">
<div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 12px;">
  <h1 style="margin: 0;">CSV Match (Round 4)</h1>
  <button id="themeToggle" class="theme-toggle" type="button">Switch theme</button>
</div>
<p class="muted">Upload two CSVs, choose a <b>Primary</b>, map <b>Name</b>/<b>Team</b> (Name can be composed like first+last), review unresolved rows, then export. All in-browser.</p>
<div class="row">
  <label><b>Sport</b>
    <select id="sportSelect">
      <option value="nfl" selected>NFL</option>
      <option value="mlb">MLB</option>
      <option value="nba">NBA</option>
      <option value="nhl">NHL</option>
    </select>
  </label>
</div>

<fieldset>
  <legend>1) Upload files</legend>
  <div class="row">
    <div class="col">
      <label><b>File A</b> <input type="file" id="fileA" accept=".csv" /></label>
      <div id="metaA" class="small muted"></div>
    </div>
    <div class="col">
      <label><b>File B</b> <input type="file" id="fileB" accept=".csv" /></label>
      <div id="metaB" class="small muted"></div>
    </div>
  </div>
  <div class="row">
    <label><input type="radio" name="primary" value="A" checked> Primary = File A</label>
    <label><input type="radio" name="primary" value="B"> Primary = File B</label>
  </div>
</fieldset>

<fieldset>
  <legend>2) Choose match keys</legend>
  <div class="grid">
    <div>
      <div><b>File A</b></div>
      <div class="row-inline">
        <label>Name mode:
          <select id="nameModeA">
            <option value="single">Single column</option>
            <option value="compose">Compose from columns</option>
          </select>
        </label>
        <label id="nameASingleWrap">Name: <select id="nameA"></select></label>
      </div>
      <div id="nameAComposeWrap" class="row-inline" style="display:none;">
        <label>Compose:
          <select id="nameACompose" multiple size="5" style="min-width:220px;"></select>
        </label>
        <label>Separator: <input type="text" id="nameASeparator" value=" " size="2"/></label>
      </div>
      <label>Team: <select id="teamA"></select></label>
    </div>
    <div>
      <div><b>File B</b></div>
      <div class="row-inline">
        <label>Name mode:
          <select id="nameModeB">
            <option value="single">Single column</option>
            <option value="compose">Compose from columns</option>
          </select>
        </label>
        <label id="nameBSingleWrap">Name: <select id="nameB"></select></label>
      </div>
      <div id="nameBComposeWrap" class="row-inline" style="display:none;">
        <label>Compose:
          <select id="nameBCompose" multiple size="5" style="min-width:220px;"></select>
        </label>
        <label>Separator: <input type="text" id="nameBSeparator" value=" " size="2"/></label>
      </div>
      <label>Team: <select id="teamB"></select></label>
    </div>
  </div>
  <div class="small muted">Matching is restricted to the same canonical team (prevents cross-team collisions). DST names auto-normalized (e.g., "Baltimore D/ST" â†’ "Baltimore Ravens").</div>
</fieldset>

<fieldset>
  <legend>3) Column mapping</legend>
  
  <!-- Required columns section -->
  <div style="margin-bottom: 20px;">
    <div><b>Required columns</b> <span class="small muted">(must be mapped)</span></div>
    <div id="requiredMapping" class="box small" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center;"></div>
  </div>
  
  <!-- Optional columns section -->
  <div>
    <div><b>Optional columns</b> <span class="small muted">(will appear in output even if empty)</span></div>
    <div id="optionalMapping" class="box small"></div>
    <button type="button" id="addOptionalColumn" style="margin-top: 8px;">+ Add optional column</button>
  </div>
</fieldset>

<fieldset>
  <legend>4) Team validation</legend>
  <div id="teamValidationSection" style="display:none;">
    <div class="row">
      <div id="teamValidationStatus" class="small"></div>
    </div>
    <div id="teamMappingSection" style="display:none; margin-top: 10px;">
      <h4>Manual team mapping required</h4>
      <p class="small muted">Map unmatched teams from Sheet 1 to available teams in Sheet 2:</p>
      <div id="teamMappingContainer" class="box small"></div>
      <div class="row">
        <button id="btnSaveTeamMappings">Save team mappings</button>
        <button id="btnSkipTeamValidation" class="secondary">Skip validation</button>
      </div>
    </div>
  </div>
</fieldset>

<fieldset>
  <legend>5) Merge</legend>
  <div class="row">
    <button id="btnMerge" disabled>Run match</button>
    <span id="status" class="muted"></span>
  </div>
  <div id="summary" class="small"></div>

  <div id="reviewSection" style="display:none; margin-top:10px;">
    <h3>Review unresolved rows</h3>
    <p class="small muted">Pick a candidate within the same team, or choose "No match". Tick "Save alias" to remember your choice.</p>
    <div class="review-table">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Primary Name</th>
            <th>Team</th>
            <th>Candidates (same team)</th>
            <th>Save alias</th>
          </tr>
        </thead>
        <tbody id="reviewBody"></tbody>
      </table>
    </div>
    <div class="row">
      <button id="btnApplyReview">Apply review & update</button>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="btnExportCSV" disabled>Download merged.csv</button>
    <button id="btnExportManifest" disabled>Download manifest.json</button>
  </div>
</fieldset>

<script src="script.js"></script>
</body>
</html>
